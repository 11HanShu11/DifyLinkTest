name: Generate C# Class Diagrams

on:
  push:
    paths:
      - "**.cs"
  pull_request:
    paths:
      - "**.cs"

jobs:
  generate-diagram:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. å…¨C#ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ã—ã¦Difyã«é€ä¿¡
      - name: Generate class diagrams with Dify (Smart Mode)
        id: generate_diagram
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}
        run: |
          mkdir -p docs/debug

          # docs/ClassDiagrams.mdã®æœ‰ç„¡ã‚’ç¢ºèª
          if [ ! -f docs/ClassDiagrams.md ]; then
            echo "ClassDiagrams.mdãŒå­˜åœ¨ã—ãªã„ã®ã§å…¨.csãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡ã—ã¾ã™"
            TARGET_FILES=$(find . -name "*.cs" -type f)
          else
            echo "ClassDiagrams.mdãŒå­˜åœ¨ã™ã‚‹ã®ã§å·®åˆ†ã®ã¿é€ä¿¡ã—ã¾ã™"
            # æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã¨ã®å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å–å¾—ï¼ˆmainã¨ã®æ¯”è¼ƒä¾‹ï¼‰
            CHANGED_CS=$(git diff --name-only origin/main...HEAD | grep '\.cs$' || true)
            # docs/ClassDiagrams.mdã‚‚å¿…ãšæ¸¡ã™
            if [ -f docs/ClassDiagrams.md ]; then
              TARGET_FILES="docs/ClassDiagrams.md $CHANGED_CS"
            else
              TARGET_FILES="$CHANGED_CS"
            fi
          fi

          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°çµ‚äº†
          if [ -z "$TARGET_FILES" ]; then
            echo "No files to process"
            exit 0
          fi

          # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’JSONåŒ–
          ALL_FILES_JSON="{"
          FIRST=true

          for file in $TARGET_FILES; do
            if [ ! -f "$file" ]; then continue; fi
            SAFE_KEY=$(echo "$file" | sed 's/[^a-zA-Z0-9]/_/g')
            FILE_CONTENT=$(jq -Rs . "$file")
            if [ "$FIRST" = true ]; then
              ALL_FILES_JSON="${ALL_FILES_JSON}\"${SAFE_KEY}\": $FILE_CONTENT"
              FIRST=false
            else
              ALL_FILES_JSON="${ALL_FILES_JSON}, \"${SAFE_KEY}\": $FILE_CONTENT"
            fi
          done
          ALL_FILES_JSON="${ALL_FILES_JSON}}"

          echo "$ALL_FILES_JSON" > docs/debug/all_files.json

          # C#ãƒ•ã‚¡ã‚¤ãƒ«ã‚’JSONåŒ–ã—ã¦ALL_FILES_JSONã«
          CS_CODE=""
          for file in $TARGET_FILES; do
            if [ ! -f "$file" ]; then continue; fi
            if [[ "$file" == *.cs ]]; then
              CONTENT=$(cat "$file")
              CS_CODE="${CS_CODE}\n${CONTENT}\n"
            fi
          done
          CS_CODE_JSON=$(printf "%s" "$CS_CODE" | jq -Rs .)

          EXISTING_MD=""
          if [ -f docs/ClassDiagrams.md ]; then
            EXISTING_MD=$(jq -Rs . docs/ClassDiagrams.md)
          fi
          # inputsçµ„ã¿ç«‹ã¦éƒ¨åˆ†
          if [ -n "$EXISTING_MD" ]; then
            INPUTS="{\"csharp_code\": $CS_CODE_JSON, \"ClassDiagramsMd\": $EXISTING_MD}"
          else
            INPUTS="{\"csharp_code\": $CS_CODE_JSON}"
          fi

          JSON_PAYLOAD="{\"workflow_id\": \"${DIFY_WORKFLOW_ID}\", \"inputs\": $INPUTS, \"response_mode\": \"blocking\", \"user\": \"github-actions-bot\"}"
          echo "$JSON_PAYLOAD" | jq . # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          

          # ============ä¿®æ­£============
          # ãƒ†ã‚¹ãƒˆç”¨ã«çŸ­ã„ã‚³ãƒ¼ãƒ‰ã ã‘é€ä¿¡
          CS_CODE_JSON=$(jq -Rs . <<<"public class Test {}")
          INPUTS="{\"csharp_code\": $CS_CODE_JSON}"

          RESPONSE=$(curl -s -X POST "https://api.dify.ai/v1/workflows/run" \
            --header "Authorization: Bearer ${DIFY_API_KEY}" \
            --header "Content-Type: application/json" \
            --data-raw "{
              \"workflow_id\": \"${DIFY_WORKFLOW_ID}\",
              \"inputs\": $INPUTS,
              \"response_mode\": \"blocking\",
              \"user\": \"github-actions-bot\"
            }")
          # ============ä¿®æ­£============

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°å‡ºåŠ›
          echo "API Response:"
          echo "$RESPONSE" | jq . || echo "$RESPONSE"

          # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¿å­˜
          echo "$RESPONSE" > docs/debug/dify_response.json

          # çµæœã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«å¤‰æ›
          echo "## ğŸ¤– AI Generated C# Class Diagrams" > docs/ClassDiagrams.md
          echo "" >> docs/ClassDiagrams.md
          echo "*Generated from all C# files in the repository*" >> docs/ClassDiagrams.md
          echo "" >> docs/ClassDiagrams.md

          # Mermaidå›³ã‚’å–å¾—
          MERMAID_RESULT=$(echo "$RESPONSE" | jq -r '.data.outputs.mermaid_diagram // .data.outputs.class_diagram // .data.outputs.result' 2>/dev/null || echo "")

          if [ -n "$MERMAID_RESULT" ] && [ "$MERMAID_RESULT" != "null" ] && [ "$MERMAID_RESULT" != "" ]; then
            echo "<details><summary>ğŸ“Š Complete Class Diagram</summary>" >> docs/ClassDiagrams.md
            echo "" >> docs/ClassDiagrams.md
            
            # Mermaidãƒ–ãƒ­ãƒƒã‚¯ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if echo "$MERMAID_RESULT" | grep -q '```mermaid'; then
              echo "$MERMAID_RESULT" >> docs/ClassDiagrams.md
            else
              echo '```mermaid' >> docs/ClassDiagrams.md
              echo "$MERMAID_RESULT" >> docs/ClassDiagrams.md
              echo '```' >> docs/ClassDiagrams.md
            fi
            
            echo "" >> docs/ClassDiagrams.md
            echo "</details>" >> docs/ClassDiagrams.md
          else
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"' 2>/dev/null || echo "Failed to parse response")
            echo "âŒ **Failed to generate class diagram**" >> docs/ClassDiagrams.md
            echo "" >> docs/ClassDiagrams.md
            echo "Error: $ERROR_MSG" >> docs/ClassDiagrams.md
          fi

          # å‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¿½åŠ 
          echo "" >> docs/ClassDiagrams.md
          echo "### ğŸ“ Processed Files" >> docs/ClassDiagrams.md
          echo "" >> docs/ClassDiagrams.md
          for file in $CS_FILES; do
            if [ -f "$file" ]; then
              echo "- \`$file\`" >> docs/ClassDiagrams.md
            fi
          done

      # 3. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit & push updated class diagram
        run: |
          git config user.name "github-actions-bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
          git config pull.rebase false

          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet docs/ClassDiagrams.md; then
            echo "No changes to commit"
            exit 0
          fi

          git add docs/ClassDiagrams.md
          if [ -d docs/debug ]; then
            git add docs/debug/
          fi

          git commit -m "Update C# class diagrams [skip ci]" || {
            echo "No changes to commit"
            exit 0
          }

          # ãƒ—ãƒƒã‚·ãƒ¥ã‚’æœ€å¤§3å›è©¦è¡Œ
          for i in {1..3}; do
            if git push origin HEAD:main; then
              echo "âœ… Push successful"
              break
            else
              echo "âŒ Push failed, attempt $i of 3"
              if [ $i -lt 3 ]; then
                echo "Fetching latest changes..."
                git fetch origin
                git pull origin main --no-rebase || {
                  echo "Resolving conflicts (ours for all unmerged files)..."
                  # ç«¶åˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¨ã¦ourså„ªå…ˆã§è‡ªå‹•è§£æ±º
                  for f in $(git diff --name-only --diff-filter=U); do
                    git checkout --ours -- "$f"
                    git add "$f"
                  done
                  git commit -m "Resolve conflicts - keep generated diagrams [skip ci]" || true
                }
                sleep 2
              else
                echo "âŒ Push failed after 3 attempts"
                exit 1
              fi
            fi
          done