name: Generate C# Class Diagram # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰ [5]

on:
  pull_request: # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼
    types: [opened, synchronize, reopened] # PRã‚ªãƒ¼ãƒ—ãƒ³ã€åŒæœŸã€å†ã‚ªãƒ¼ãƒ—ãƒ³æ™‚ [6]
    paths:
      - '**.cs' # .csãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ [5]

jobs:
  generate-diagram:
    runs-on: ubuntu-latest # æœ€æ–°ã®Ubuntuãƒ©ãƒ³ãƒŠãƒ¼ã§å®Ÿè¡Œ [5]
    permissions:
      contents: read # ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®ãŸã‚ã«å¿…è¦ [6]
      pull-requests: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ãŸã‚ã«å¿…è¦ [6]
      issues: write # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã™ã‚‹ãŸã‚ã«å¿…è¦ (issues APIã‚’ä½¿ç”¨) [6]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ [5, 7]
      with:
        fetch-depth: 0 # å·®åˆ†å–å¾—ã®ãŸã‚ã«å…¨ã¦ã®å±¥æ­´ã‚’ãƒ•ã‚§ãƒƒãƒã€‚git diff ã«å¿…è¦ [6, 7]

    - name: Process changed C# files and generate diagrams
      id: dify_process # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®IDã‚’è¨­å®šã—ã€å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§å‡ºåŠ›ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      env:
        DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }} # Dify APIã‚­ãƒ¼ (GitHub Secretsã«è¨­å®š) [8]
        DIFY_BASE_URL: 'https://api.dify.ai/v1' # Difyã®ãƒ™ãƒ¼ã‚¹URL [8, 9]
        DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }} # Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ID (GitHub Secretsã«è¨­å®š) [8]
      run: |
        # å¤‰æ›´ã•ã‚ŒãŸ.csãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
        # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ™ãƒ¼ã‚¹ã‚³ãƒŸãƒƒãƒˆ (PRã®å…ƒã¨ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ) ã¨
        # ãƒ˜ãƒƒãƒ‰ã‚³ãƒŸãƒƒãƒˆ (PRãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ) ã®é–“ã®å·®åˆ†ã‹ã‚‰ã€å¤‰æ›´ã•ã‚ŒãŸ.csãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º [7, 10]
        CHANGED_CS_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.cs$')

        if [ -z "$CHANGED_CS_FILES" ]; then
          echo "No C# files changed in this pull request. Skipping diagram generation."
          # ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒ‡ã‚£ã‚’ç©ºã«è¨­å®šã—ã€å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã•ã›ã‚‹
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit 0
        fi

        # ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒ‡ã‚£ã®åˆæœŸåŒ–
        FULL_COMMENT_BODY="## ğŸ¤– AI Generated C# Class Diagrams\n\n"
        
        # å„å¤‰æ›´ã•ã‚ŒãŸC#ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å‘¼ã³å‡ºã—ã€çµæœã‚’é›†ç´„ [7, 11]
        # while IFS= read -r ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«ã‚¹ãƒšãƒ¼ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚æ­£ã—ãå‡¦ç†ã™ã‚‹ãŸã‚ã®æ…£ç”¨å¥
        while IFS= read -r file_path; do
          if [ -n "$file_path" ]; then # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
            echo "Processing file: $file_path"
            # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’èª­ã¿è¾¼ã¿ã€JSONæ–‡å­—åˆ—ã¨ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— [12]
            # Dify APIã®inputsã¯JSONå½¢å¼ã®æ–‡å­—åˆ—ã‚’å—ã‘å–ã‚‹ãŸã‚ã€jq -Rs . ã‚’ä½¿ç”¨
            FILE_CONTENT=$(cat "$file_path" | jq -Rs .)

            # Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ (POST /workflows/:workflow_id/run) [13, 14]
            RESPONSE=$(curl -X POST "${{ env.DIFY_BASE_URL }}/workflows/${{ env.DIFY_WORKFLOW_ID }}/run" \
              -H "Authorization: Bearer ${{ env.DIFY_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d '{
                "inputs": {
                  "csharp_code": '"$FILE_CONTENT"' # Difyãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å…¥åŠ›å¤‰æ•° "csharp_code" ã«ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’æ¸¡ã™ [2, 4]
                },
                "response_mode": "blocking", # å®Ÿè¡Œå®Œäº†å¾Œã«çµæœã‚’è¿”ã™ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ [8, 15, 16]
                "user": "github-actions-bot" # Difyã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­ [15-17]
              }')

            # Difyã‹ã‚‰ã®å¿œç­”ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã€ã‚¯ãƒ©ã‚¹å›³ã®Mermaidã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º [17, 18]
            MERMAID_DIAGRAM=$(echo "$RESPONSE" | jq -r '.data.outputs.mermaid_diagram')

            if [ -n "$MERMAID_DIAGRAM" ]; then
              # Mermaidã‚³ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚ŒãŸå ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒ‡ã‚£ã«è¿½åŠ  [17]
              FULL_COMMENT_BODY+="### for \`$file_path\`\n"
              FULL_COMMENT_BODY+="<details><summary>Click to expand diagram for \`$file_path\`</summary>\n\n\`\`\`mermaid\n$MERMAID_DIAGRAM\n\`\`\`\n\n</details>\n\n"
            else
              # ç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆ
              FULL_COMMENT_BODY+="### for \`$file_path\`\n"
              FULL_COMMENT_BODY+="*Dify AI failed to generate a Mermaid diagram or no classes were found for this file.* \n\n"
            fi
          fi
        done <<< "$CHANGED_CS_FILES" # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã«æ¸¡ã™

        FULL_COMMENT_BODY+="\n*Powered by Dify AI*"
        
        # GitHub Actionsã®å‡ºåŠ›ã¨ã—ã¦è¤‡æ•°è¡Œã®ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒ‡ã‚£ã‚’è¨­å®š (æ–°ã—ã„æ›¸ãæ–¹)
        # https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/
        echo "comment_body<<EOF" >> $GITHUB_OUTPUT
        echo "$FULL_COMMENT_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Post aggregated comment to GitHub
      uses: actions/github-script@v6 # GitHub APIã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ [19]
      # ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒ‡ã‚£ãŒç©ºã§ãªã„å ´åˆã«ã®ã¿å®Ÿè¡Œ
      if: ${{ always() && steps.dify_process.outputs.comment_body != '' }}
      env:
          COMMENT_BODY: ${{ steps.dify_process.outputs.comment_body }}
      with:
        script: |
          const commentBody = process.env.COMMENT_BODY;
          const { owner, repo } = context.repo;
          const pullRequestNumber = context.payload.pull_request?.number; // PRç•ªå·ã‚’å–å¾— [20]

          if (!pullRequestNumber) {
            console.log("This is not a pull request event. Skipping comment posting.");
            return;
          }

          await github.rest.issues.createComment({ # GitHubã®issues APIã‚’ä½¿ã£ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ [19, 21]
            owner,
            repo,
            issue_number: pullRequestNumber, # PRç•ªå·ã‚’issue_numberã¨ã—ã¦ä½¿ç”¨ [20]
            body: commentBody
          });
