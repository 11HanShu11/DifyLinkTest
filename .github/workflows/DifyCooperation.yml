name: Dify AI Code Analysis for C# (ID Method)

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.cs'

permissions:
  pull-requests: write

jobs:
  analyze_cs_code_with_dify:
    runs-on: ubuntu-latest
    env:
      # ★★★ 修正点1: 使用するシークレットを2つに分割 ★★★
      DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
      DIFY_API_BASE_URL: ${{ secrets.DIFY_API_BASE_URL }} # 例: https://api.dify.ai/v1
      DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}   # ワークフローIDのみ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed C# files
        id: changed-files
        run: |
          files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.cs$' || true)
          if [ -z "$files" ]; then
            echo "No C# files changed."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "C# files to analyze: $files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "files_json=$(echo "$files" | jq -R -s -c 'split("\n") | map(select(length > 0))')" >> $GITHUB_OUTPUT
          fi

      - name: Analyze each file with Dify API
        if: steps.changed-files.outputs.has_changes == 'true'
        id: analysis
        run: |
          final_report="## :robot: Dify AI Code Analysis Report (C#)\n\n"
          
          # ★★★ 修正点2: APIエンドポイントを固定 ★★★
          API_ENDPOINT="${DIFY_API_BASE_URL}/workflows/run"
          echo "Using Dify API Endpoint: $API_ENDPOINT"

          for file in $(echo '${{ steps.changed-files.outputs.files_json }}' | jq -r '.[]'); do
            echo "--- Analyzing $file ---"
            
            encoded_content=$(base64 -w 0 "$file")
            
            # ★★★ 修正点3: jqを使ってJSONペイロードにworkflow_idを追加 ★★★
            json_payload=$(jq -n \
              --arg ec "$encoded_content" \
              --arg user "github-actions-${{ github.actor }}" \
              --arg workflow_id "$DIFY_WORKFLOW_ID" \
              '{
                "inputs": {
                  "encoded_script": $ec
                },
                "response_mode": "blocking",
                "user": $user,
                "workflow_id": $workflow_id
              }')
            
            # DifyのワークフローAPIを呼び出す
            api_response=$(curl --location --request POST "$API_ENDPOINT" \
              --header "Authorization: Bearer $DIFY_API_KEY" \
              --header 'Content-Type: application/json' \
              --data "$json_payload" \
              --silent)
              
            echo "--- Raw Dify API Response for $file ---"
            echo "$api_response"
            echo "----------------------------------------"
            
            mermaid_diagram=$(echo "$api_response" | jq -r '.answer')
          
            final_report+="### Analysis for \\\`$file\\\`\n\n"
            final_report+="**Mermaid Class Diagram:**\n\`\`\`mermaid\n${mermaid_diagram}\n\`\`\`\n\n---\n"
          done
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$final_report" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post analysis result to Pull Request
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // コメント投稿のロジックは変更なし
            const report = `${{ steps.analysis.outputs.report }}`;
            const { owner, repo, number } = context.issue;
            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: number });
            const botComment = comments.find(c => c.user.login === 'github-actions[bot]' && c.body.includes('Dify AI Code Analysis Report'));
            if (botComment) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: botComment.id, body: report });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: number, body: report });
            }