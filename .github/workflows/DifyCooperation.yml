name: Generate C# Class Diagrams

on:
  push:
    paths:
      - "**.cs"
  pull_request:
    paths:
      - "**.cs"

jobs:
  generate-diagram:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼èª­ã¿è¾¼ã¿ãƒ»åˆæœŸåŒ–
      - name: Load counter
        id: load_counter
        run: |
          if [ -f ".classdiagram_counter" ]; then
            COUNTER=$(cat .classdiagram_counter)
          else
            COUNTER=0
            echo "0" > .classdiagram_counter
          fi
          echo "counter=$COUNTER" >> $GITHUB_OUTPUT

      # 3. åˆå›å…¨ä½“ç”Ÿæˆåˆ¤å®š
      - name: Determine full or diff update
        id: determine_update
        run: |
          if [ ! -f "docs/ClassDiagrams.md" ]; then
            echo "update_type=full" >> $GITHUB_OUTPUT
          elif [ ${{ steps.load_counter.outputs.counter }} -ge 10 ]; then
            echo "update_type=full" >> $GITHUB_OUTPUT
          else
            echo "update_type=diff" >> $GITHUB_OUTPUT
          fi

      # 4. Dify ã«é€ä¿¡ã—ã¦ Mermaid ä½œæˆï¼ˆä¿®æ­£ç‰ˆï¼‰
      - name: Generate class diagrams with Dify (Fixed)
        id: generate_diagram
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}
        run: |
          mkdir -p docs/debug

          if [ "${{ steps.determine_update.outputs.update_type }}" == "full" ]; then
            echo "Performing full generation..."
            FILES=$(find . -name "*.cs")
          else
            echo "Performing diff update..."
            FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.cs$' || true)
          fi

          # ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
          echo "## ğŸ¤– AI Generated C# Class Diagrams" > docs/ClassDiagrams.md
          echo "" >> docs/ClassDiagrams.md

          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -z "$FILES" ]; then
            echo "No .cs files found to process"
            echo "No .cs files to process" >> docs/ClassDiagrams.md
          else
            for file in $FILES; do
              echo "Processing $file"
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if [ ! -f "$file" ]; then
                echo "Warning: File $file does not exist, skipping..."
                continue
              fi
              
              # JSON ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
              FILE_CONTENT=$(jq -Rs . "$file")
              
              # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å®‰å…¨åŒ–ã—ã¦ä¿å­˜
              SAFE_NAME=$(basename "$file" | tr '/' '_' | tr ' ' '_')
              echo "$FILE_CONTENT" > "docs/debug/${SAFE_NAME}.json"
              
              # Dify API å‘¼ã³å‡ºã—
              RESPONSE=$(curl -s -X POST "https://api.dify.ai/v1/workflows/run" \
                --header "Authorization: Bearer ${DIFY_API_KEY}" \
                --header "Content-Type: application/json" \
                --data-raw "{\"workflow_id\": \"${DIFY_WORKFLOW_ID}\", \"inputs\": { \"csharp_code\": $FILE_CONTENT }, \"response_mode\": \"blocking\", \"user\": \"github-actions-bot\"}")
              
              # ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
              echo "API Response for $file:"
              echo "$RESPONSE" | jq . || echo "$RESPONSE"
              
              # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚ä¿å­˜
              echo "$RESPONSE" > "docs/debug/${SAFE_NAME}_response.json"
              
              # Mermaid å‡ºåŠ›ã‚’å–å¾—
              MERMAID=$(echo "$RESPONSE" | jq -r '.data.outputs.mermaid_diagram' 2>/dev/null || echo "")
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
              echo "### $file" >> docs/ClassDiagrams.md
              echo "<details><summary>Expand</summary>" >> docs/ClassDiagrams.md
              echo "" >> docs/ClassDiagrams.md
              
              if [ -n "$MERMAID" ] && [ "$MERMAID" != "null" ] && [ "$MERMAID" != "" ]; then
                # Mermaidã‚³ãƒ¼ãƒ‰ãŒã™ã§ã«```mermaidãƒ–ãƒ­ãƒƒã‚¯ã‚’å«ã‚“ã§ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if echo "$MERMAID" | grep -q '```mermaid'; then
                  # ã™ã§ã«ãƒ–ãƒ­ãƒƒã‚¯ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾å‡ºåŠ›
                  echo "$MERMAID" >> docs/ClassDiagrams.md
                else
                  # ãƒ–ãƒ­ãƒƒã‚¯ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
                  echo '```mermaid' >> docs/ClassDiagrams.md
                  echo "$MERMAID" >> docs/ClassDiagrams.md
                  echo '```' >> docs/ClassDiagrams.md
                fi
              else
                ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"' 2>/dev/null || echo "Failed to parse response")
                echo "*Failed to generate diagram*: $ERROR_MSG" >> docs/ClassDiagrams.md
              fi
              
              echo "</details>" >> docs/ClassDiagrams.md
              echo "" >> docs/ClassDiagrams.md
            done
          fi

      # DIFY_WORKFLOW_IDã®æ–‡å­—æ•°å–å¾—
      - name: Debug workflow id
        run: |
          echo "Length of workflow id: ${#DIFY_WORKFLOW_ID}"
          if [ ${#DIFY_WORKFLOW_ID} -gt 10 ]; then
            echo "Starts with: ${DIFY_WORKFLOW_ID:0:5}"
            echo "Ends with: ${DIFY_WORKFLOW_ID: -5}"
          else
            echo "Workflow ID seems too short"
          fi
        env:
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}

      # 5. ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
      - name: Update counter
        run: |
          if [ "${{ steps.determine_update.outputs.update_type }}" == "full" ]; then
            echo "0" > .classdiagram_counter
          else
            COUNTER=${{ steps.load_counter.outputs.counter }}
            COUNTER=$((COUNTER + 1))
            echo "$COUNTER" > .classdiagram_counter
          fi

     # 6. Commit & push with force (ä»£æ›¿æ¡ˆ)
      - name: Commit & force push updated diagrams
        run: |
          git config user.name "github-actions-bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
          [ -f .classdiagram_counter ] || echo "0" > .classdiagram_counter
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
          git fetch origin main
          git reset --hard origin/main
          
          # å†åº¦å›³è¡¨ã‚’ç”Ÿæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          git add docs/ClassDiagrams.md .classdiagram_counter
          if [ -d docs/debug ]; then
            git add docs/debug/
          fi
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚‚ã†ä¸€åº¦ãƒã‚§ãƒƒã‚¯
          if git diff --cached --quiet; then
            echo "No changes after reset"
            exit 0
          fi
          
          git commit -m "Update C# class diagrams [skip ci]"
          git push origin HEAD:main