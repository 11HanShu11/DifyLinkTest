name: Generate C# Class Diagrams

on:
  push:
    paths:
      - '**.cs'
  pull_request:
    paths:
      - '**.cs'

jobs:
  generate-diagram:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. „É™„Éù„Ç∏„Éà„É™„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. „Ç´„Ç¶„É≥„Çø„ÉºË™≠„ÅøËæº„Åø„ÉªÂàùÊúüÂåñ
      - name: Load counter
        id: load_counter
        run: |
          if [ -f ".classdiagram_counter" ]; then
            COUNTER=$(cat .classdiagram_counter)
          else
            COUNTER=0
            echo "0" > .classdiagram_counter
          fi
          echo "counter=$COUNTER" >> $GITHUB_OUTPUT

      # 3. ÂàùÂõûÂÖ®‰ΩìÁîüÊàêÂà§ÂÆö
      - name: Determine full or diff update
        id: determine_update
        run: |
          if [ ! -f "docs/ClassDiagrams.md" ]; then
            echo "update_type=full" >> $GITHUB_OUTPUT
          elif [ ${{ steps.load_counter.outputs.counter }} -ge 10 ]; then
            echo "update_type=full" >> $GITHUB_OUTPUT
          else
            echo "update_type=diff" >> $GITHUB_OUTPUT
          fi

      # 4. Dify „Å´ÈÄÅ‰ø°„Åó„Å¶ Mermaid ‰ΩúÊàêÔºà‰øÆÊ≠£ÁâàÔºâ
      - name: Generate class diagrams with Dify (Fixed)
        id: generate_diagram
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}
        run: |
          mkdir -p docs/debug
          
          if [ "${{ steps.determine_update.outputs.update_type }}" == "full" ]; then
            echo "Performing full generation..."
            FILES=$(find . -name "*.cs")
          else
            echo "Performing diff update..."
            FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.cs$' || true)
          fi
          
          # „Éò„ÉÉ„ÉÄ„Éº„Çí‰ΩúÊàê
          echo "## ü§ñ AI Generated C# Class Diagrams" > docs/ClassDiagrams.md
          echo "" >> docs/ClassDiagrams.md
          
          # „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if [ -z "$FILES" ]; then
            echo "No .cs files found to process"
            echo "No .cs files to process" >> docs/ClassDiagrams.md
          else
            for file in $FILES; do
              echo "Processing $file"
              
              # „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
              if [ ! -f "$file" ]; then
                echo "Warning: File $file does not exist, skipping..."
                continue
              fi
              
              # JSON „Ç®„Çπ„Ç±„Éº„Éó
              FILE_CONTENT=$(jq -Rs . "$file")
              
              # „Éï„Ç°„Ç§„É´Âêç„ÇíÂÆâÂÖ®Âåñ„Åó„Å¶‰øùÂ≠ò
              SAFE_NAME=$(basename "$file" | tr '/' '_' | tr ' ' '_')
              echo "$FILE_CONTENT" > "docs/debug/${SAFE_NAME}.json"
              
              # Dify API Âëº„Å≥Âá∫„Åó
              RESPONSE=$(curl -s -X POST "https://api.dify.ai/v1/workflows/run" \
                --header "Authorization: Bearer ${DIFY_API_KEY}" \
                --header "Content-Type: application/json" \
                --data-raw "{\"workflow_id\": \"${DIFY_WORKFLOW_ID}\", \"inputs\": { \"csharp_code\": $FILE_CONTENT }, \"response_mode\": \"blocking\", \"user\": \"github-actions-bot\"}")
              
              # Áîü„É¨„Çπ„Éù„É≥„Çπ„Çí„É≠„Ç∞„Å´Âá∫ÂäõÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
              echo "API Response for $file:"
              echo "$RESPONSE" | jq . || echo "$RESPONSE"
              
              # „Éá„Éê„ÉÉ„Ç∞Áî®„Å´„É¨„Çπ„Éù„É≥„Çπ„ÇÇ‰øùÂ≠ò
              echo "$RESPONSE" > "docs/debug/${SAFE_NAME}_response.json"
              
              # Mermaid Âá∫Âäõ„ÇíÂèñÂæó
              MERMAID=$(echo "$RESPONSE" | jq -r '.data.outputs.mermaid_diagram' 2>/dev/null || echo "")
              
              # „Éï„Ç°„Ç§„É´„Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†
              echo "### $file" >> docs/ClassDiagrams.md
              echo "<details><summary>Expand</summary>" >> docs/ClassDiagrams.md
              echo "" >> docs/ClassDiagrams.md
              
              if [ -n "$MERMAID" ] && [ "$MERMAID" != "null" ] && [ "$MERMAID" != "" ]; then
                echo '```mermaid' >> docs/ClassDiagrams.md
                echo "$MERMAID" >> docs/ClassDiagrams.md
                echo '```' >> docs/ClassDiagrams.md
              else
                ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"' 2>/dev/null || echo "Failed to parse response")
                echo "*Failed to generate diagram*: $ERROR_MSG" >> docs/ClassDiagrams.md
              fi
              
              echo "</details>" >> docs/ClassDiagrams.md
              echo "" >> docs/ClassDiagrams.md
            done
          fi

      # DIFY_WORKFLOW_ID„ÅÆÊñáÂ≠óÊï∞ÂèñÂæó
      - name: Debug workflow id
        run: |
          echo "Length of workflow id: ${#DIFY_WORKFLOW_ID}"
          if [ ${#DIFY_WORKFLOW_ID} -gt 10 ]; then
            echo "Starts with: ${DIFY_WORKFLOW_ID:0:5}"
            echo "Ends with: ${DIFY_WORKFLOW_ID: -5}"
          else
            echo "Workflow ID seems too short"
          fi
        env:
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}

      # 5. „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
      - name: Update counter
        run: |
          if [ "${{ steps.determine_update.outputs.update_type }}" == "full" ]; then
            echo "0" > .classdiagram_counter
          else
            COUNTER=${{ steps.load_counter.outputs.counter }}
            COUNTER=$((COUNTER + 1))
            echo "$COUNTER" > .classdiagram_counter
          fi

      # ‰ª£ÊõøÊ°à: Á´∂Âêà„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÅÆPull Request„Éô„Éº„Çπ„ÅÆ„Ç¢„Éó„É≠„Éº„ÉÅ

      # 6. Create Pull Request instead of direct push
      - name: Create Pull Request with updated diagrams
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions-bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
          [ -f .classdiagram_counter ] || echo "0" > .classdiagram_counter
          
          # Â§âÊõ¥„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to create PR"
            exit 0
          fi
          
          git add docs/ClassDiagrams.md .classdiagram_counter
          if [ -d docs/debug ]; then
            git add docs/debug/
          fi
          
          # ‰∏ÄÊÑè„Å™„Éñ„É©„É≥„ÉÅÂêç„Çí‰ΩúÊàê
          BRANCH_NAME="update-class-diagrams-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          git commit -m "Update C# class diagrams"
          git push origin "$BRANCH_NAME"
          
          # Pull Request„Çí‰ΩúÊàê
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls" \
            -d "{
              \"title\": \"Auto-update: C# Class Diagrams\",
              \"head\": \"$BRANCH_NAME\",
              \"base\": \"main\",
              \"body\": \"Automatically generated class diagrams from C# code changes.\"
            }"