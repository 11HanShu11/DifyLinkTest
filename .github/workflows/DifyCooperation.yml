name: Generate C# Class Diagrams

on:
  push:
    paths:
      - '**.cs'
  pull_request:
    paths:
      - '**.cs'

jobs:
  generate-diagram:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. „É™„Éù„Ç∏„Éà„É™„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. „Ç´„Ç¶„É≥„Çø„ÉºË™≠„ÅøËæº„Åø„ÉªÂàùÊúüÂåñ
      - name: Load counter
        id: load_counter
        run: |
          if [ -f ".classdiagram_counter" ]; then
            COUNTER=$(cat .classdiagram_counter)
          else
            COUNTER=0
            # ÂàùÂõû„Å´„Éï„Ç°„Ç§„É´„Çí‰Ωú„ÇãÔºà„Åì„Çå„Åß‰ª•Èôç„ÅÆ git add „Ç®„É©„Éº„ÇíÈò≤Ê≠¢Ôºâ
            echo "0" > .classdiagram_counter
          fi
          echo "counter=$COUNTER" >> $GITHUB_OUTPUT

      # 3. ÂàùÂõûÂÖ®‰ΩìÁîüÊàêÂà§ÂÆö
      - name: Determine full or diff update
        id: determine_update
        run: |
          if [ ! -f "docs/ClassDiagrams.md" ]; then
            echo "update_type=full" >> $GITHUB_OUTPUT
          elif [ ${{ steps.load_counter.outputs.counter }} -ge 10 ]; then
            echo "update_type=full" >> $GITHUB_OUTPUT
          else
            echo "update_type=diff" >> $GITHUB_OUTPUT
          fi

      # 4. Dify „Å´ÈÄÅ‰ø°„Åó„Å¶ Mermaid ‰ΩúÊàêÔºà„Éá„Éê„ÉÉ„Ç∞Âº∑ÂåñÁâàÔºâ
      # 4. Dify „Å´ÈÄÅ‰ø°„Åó„Å¶ Mermaid ‰ΩúÊàêÔºàÂÆåÂÖ®„Éá„Éê„ÉÉ„Ç∞ÁâàÔºâ
      - name: Generate class diagrams with Dify (Debug)
        id: generate_diagram
        env:
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          DIFY_WORKFLOW_ID: ${{ secrets.DIFY_WORKFLOW_ID }}
        run: |
          mkdir -p docs/debug

          if [ "${{ steps.determine_update.outputs.update_type }}" == "full" ]; then
            echo "Performing full generation..."
            FILES=$(find . -name "*.cs")
          else
            echo "Performing diff update..."
            FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.cs$' || true)
          fi

          FULL_MD="## ü§ñ AI Generated C# Class Diagrams\n\n"

          for file in $FILES; do
            echo "Processing $file"

            # JSON „Ç®„Çπ„Ç±„Éº„Éó
            FILE_CONTENT=$(jq -Rs . "$file")

            # „Éï„Ç°„Ç§„É´Âêç„ÇíÂÆâÂÖ®Âåñ„Åó„Å¶‰øùÂ≠ò
            SAFE_NAME=$(basename "$file" | tr '/' '_' | tr ' ' '_')
            echo "$FILE_CONTENT" > "docs/debug/${SAFE_NAME}.json"

            # Dify API Âëº„Å≥Âá∫„Åó
            #RESPONSE=$(curl -s -X POST "https://api.dify.ai/v1/workflows/${DIFY_WORKFLOW_ID}/run" \
            RESPONSE=$(curl -s -X POST "https://api.dify.ai/v1/workflows/aUtPPGtElU340YXf/run" \
            
              -H "Authorization: Bearer ${DIFY_API_KEY}" \
              -H "Content-Type: application/json" \
              -d '{
                "inputs": { "csharp_code": '"$FILE_CONTENT"' },
                "response_mode": "blocking",
                "user": "github-actions-bot"
              }')

            # Áîü„É¨„Çπ„Éù„É≥„Çπ„Çí„É≠„Ç∞„Å´Âá∫ÂäõÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
            echo "API Response for $file:"
            echo "$RESPONSE" | jq .

            # Mermaid Âá∫Âäõ„ÇíÂèñÂæó
            MERMAID=$(echo "$RESPONSE" | jq -r '.data.outputs.mermaid_diagram')

            if [ -n "$MERMAID" ] && [ "$MERMAID" != "null" ]; then
              FULL_MD+="### $file\n<details><summary>Expand</summary>\n\n\`\`\`mermaid\n$MERMAID\n\`\`\`\n</details>\n\n"
            else
              ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
              FULL_MD+="### $file\n*Failed to generate diagram*: $ERROR_MSG\n\n"
            fi
          done

          echo "$FULL_MD" > docs/ClassDiagrams.md

      # 5. „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
      - name: Update counter
        run: |
          if [ "${{ steps.determine_update.outputs.update_type }}" == "full" ]; then
            echo "0" > .classdiagram_counter
          else
            COUNTER=${{ steps.load_counter.outputs.counter }}
            COUNTER=$((COUNTER + 1))
            echo "$COUNTER" > .classdiagram_counter
          fi

          # 6. Commit & push updated Markdown and counter
      - name: Commit & push updated Markdown and counter
        run: |
          git config user.name "github-actions-bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
          [ -f .classdiagram_counter ] || echo "0" > .classdiagram_counter
          git add docs/ClassDiagrams.md .classdiagram_counter
          git commit -m "Update C# class diagrams [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main
